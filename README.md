# aws_k8s_sockmap_crash_reproducer

```
ubuntu@ip-10-53-1-114:~/zc$ ./k version
Client Version: v1.29.6
Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3
Server Version: v1.31.11-eks-ace6451
WARNING: version difference between client (1.29) and server (1.31) exceeds the supported minor version skew of +/-1
ubuntu@ip-10-53-1-114:~/zc$ uname -a
Linux ip-10-53-184-176.ap-southeast-1.compute.internal 6.1.140-154.222.amzn2023.x86_64 #1 SMP PREEMPT_DYNAMIC Mon Jun  2 15:11:40 UTC 2025 x86_64 Linux
```

## MPTCP

```shell
gcc -static -o srv ./mptcp_srv/srv.c
./srv
```

## Sockmap

```shell
go generate ./... && CGO_ENABLED=0 go build .
./bpf_sockmap_mptcp_bug_reproducer
```

## Reproduce (6.1.155)

```
nc localhost 8080
```

Enjoy kernel bugs:

```
[   68.473777] BUG: unable to handle page fault for address: 0000001a00000128
[   68.475145] #PF: supervisor read access in kernel mode
[   68.475624] #PF: error_code(0x0000) - not-present page
[   68.475983] PGD 105ada067 P4D 105ada067 PUD 0
[   68.476301] Oops: 0000 [#1] PREEMPT SMP NOPTI
[   68.476522] CPU: 3 PID: 421 Comm: srv Not tainted 6.1.155 #1
[   68.476804] Hardware name: QEMU Ubuntu 24.04 PC (i440FX + PIIX, 1996), BIOS 1.16.3-debian-1.16.3-2 04/01/2014
[   68.477291] RIP: 0010:mptcp_stream_accept+0xa6/0x190
[   68.477528] Code: be 58 06 00 00 e8 ca cb d4 ff 49 8b 9e 58 06 00 00 49 39 df 74 67 49 8d 44 24 40 48 89 44 24 08 eb 08 48 8b 1b 4c 39 fb 74 53 <48> 8b ab c0 00 00 00 48 83 bd 70 02 00 00 00 75 e7 48 8d bd 18 02
[   68.478334] RSP: 0018:ffffc90000bc7de0 EFLAGS: 00010282
[   68.478562] RAX: ffff8881004c93c0 RBX: 0000001a00000068 RCX: 0000000000000001
[   68.478870] RDX: 0000000000000001 RSI: 00000000fffffe00 RDI: ffffffff81aa7076
[   68.479264] RBP: 0000000000000000 R08: 0000000000000001 R09: ffffffff81914701
[   68.479574] R10: ffff888105aee000 R11: 0000000000000000 R12: ffff8881004c9380
[   68.479881] R13: 0000000000000000 R14: ffff888106fa1180 R15: ffff888106fa17d8
[   68.480195] FS:  0000000005ca4380(0000) GS:ffff8881b9cc0000(0000) knlGS:0000000000000000
[   68.480541] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[   68.480793] CR2: 0000001a00000128 CR3: 0000000100bf8004 CR4: 0000000000770ee0
[   68.481100] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[   68.481409] DR3: 0000000000000000 DR6: 00000000ffff07f0 DR7: 0000000000000400
[   68.481738] PKRU: 55555554
[   68.481860] Call Trace:
[   68.481972]  <TASK>
[   68.482072]  do_accept+0x11b/0x190
[   68.482234]  __sys_accept4+0x5b/0xc0
[   68.482398]  __x64_sys_accept+0x17/0x20
[   68.482567]  do_syscall_64+0x35/0x80
[   68.482728]  entry_SYSCALL_64_after_hwframe+0x6e/0xd8
[   68.482951] RIP: 0033:0x41b824
[   68.483095] Code: 00 00 04 00 89 01 e9 c1 fe ff ff e8 36 03 00 00 66 0f 1f 44 00 00 f3 0f 1e fa 80 3d 3d 78 09 00 00 74 13 b8 2b 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 4c c3 0f 1f 00 55 48 89 e5 48 83 ec 20 48 89
[   68.483901] RSP: 002b:00007ffffa1e9a68 EFLAGS: 00000202 ORIG_RAX: 000000000000002b
[   68.484250] RAX: ffffffffffffffda RBX: 0000000000000001 RCX: 000000000041b824
[   68.484556] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000003
[   68.484863] RBP: 00007ffffa1e9ab0 R08: 0000000000000004 R09: 0000000000000110
[   68.485178] R10: 00007ffffa1e9a7c R11: 0000000000000202 R12: 00007ffffa1e9bc8
[   68.485492] R13: 00007ffffa1e9bd8 R14: 00000000004ad868 R15: 0000000000000001
[   68.485803]  </TASK>
[   68.485904] Modules linked in:
[   68.486044] CR2: 0000001a00000128
[   68.486229] ---[ end trace 0000000000000000 ]---
[   68.486473] RIP: 0010:mptcp_stream_accept+0xa6/0x190
[   68.486690] Code: be 58 06 00 00 e8 ca cb d4 ff 49 8b 9e 58 06 00 00 49 39 df 74 67 49 8d 44 24 40 48 89 44 24 08 eb 08 48 8b 1b 4c 39 fb 74 53 <48> 8b ab c0 00 00 00 48 83 bd 70 02 00 00 00 75 e7 48 8d bd 18 02
[   68.487516] RSP: 0018:ffffc90000bc7de0 EFLAGS: 00010282
[   68.487744] RAX: ffff8881004c93c0 RBX: 0000001a00000068 RCX: 0000000000000001
[   68.488052] RDX: 0000000000000001 RSI: 00000000fffffe00 RDI: ffffffff81aa7076
[   68.488386] RBP: 0000000000000000 R08: 0000000000000001 R09: ffffffff81914701
[   68.488704] R10: ffff888105aee000 R11: 0000000000000000 R12: ffff8881004c9380
[   68.489020] R13: 0000000000000000 R14: ffff888106fa1180 R15: ffff888106fa17d8
[   68.489376] FS:  0000000005ca4380(0000) GS:ffff8881b9cc0000(0000) knlGS:0000000000000000
[   68.489721] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[   68.490005] CR2: 0000001a00000128 CR3: 0000000100bf8004 CR4: 0000000000770ee0
[   68.490368] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[   68.490673] DR3: 0000000000000000 DR6: 00000000ffff07f0 DR7: 0000000000000400
[   68.491058] PKRU: 55555554
[   68.491214] note: srv[421] exited with irqs disabled
```
